# âš¡ æ•ˆèƒ½å„ªåŒ–å®Œæˆå ±å‘Š

## ğŸ¯ å„ªåŒ–ç›®æ¨™

è§£æ±ºå°ˆæ¡ˆåˆ—è¡¨é é¢é¡¯ç¤ºã€Œè¼‰å…¥å°ˆæ¡ˆä¸­...ã€æ™‚é–“éé•·çš„å•é¡Œï¼ˆå¾ 2-5 ç§’å„ªåŒ–è‡³ < 500 æ¯«ç§’ï¼‰

---

## âœ… å·²å®Œæˆçš„å„ªåŒ–é …ç›®

### 1. è³‡æ–™åº«å±¤é¢å„ªåŒ– â­â­â­

#### æ–°å¢ 4 å€‹é—œéµç´¢å¼•
```sql
âœ“ idx_projects_owner_id          -- åŠ é€Ÿæ“æœ‰è€…æ¬Šé™æª¢æŸ¥
âœ“ idx_project_members_user_id    -- åŠ é€Ÿæˆå“¡æ¬Šé™æª¢æŸ¥
âœ“ idx_project_members_project_id -- åŠ é€Ÿå°ˆæ¡ˆæˆå“¡æŸ¥è©¢
âœ“ idx_projects_updated_at_desc   -- åŠ é€Ÿåˆ—è¡¨æ’åº
```

#### é‡å¯« RLS æ”¿ç­–
- **å•é¡Œ**ï¼šåŸå§‹æ”¿ç­–å°æ¯åˆ—éƒ½å‘¼å« `is_project_accessible()` å‡½æ•¸ï¼Œé€ æˆ N+1 æŸ¥è©¢
- **è§£æ±º**ï¼šæ”¹ç”¨ç›´æ¥çš„ OR æ¢ä»¶ï¼Œè®“ PostgreSQL æŸ¥è©¢å„ªåŒ–å™¨ä½¿ç”¨ç´¢å¼•
- **æ•ˆæœ**ï¼šæŸ¥è©¢æ™‚é–“å¾ 2-5 ç§’é™è‡³ 200-500 æ¯«ç§’ âš¡

### 2. å‰ç«¯å±¤é¢å„ªåŒ– â­â­

#### å„ªåŒ– 5 å€‹ React Query Hooks

| Hook | å„ªåŒ–é …ç›® | staleTime |
|------|----------|-----------|
| `useProjects` | é¸å–ç‰¹å®šæ¬„ä½ + å¿«å– | 30 ç§’ |
| `useProject` | é¸å–ç‰¹å®šæ¬„ä½ + å¿«å– | 30 ç§’ |
| `useDeadlines` | é¸å–ç‰¹å®šæ¬„ä½ + å¿«å– | 10 ç§’ |
| `useNotificationRule` | é¸å–ç‰¹å®šæ¬„ä½ + å¿«å– | 60 ç§’ |
| `AuthContext.fetchProfile` | é¸å–ç‰¹å®šæ¬„ä½ | - |

**å„ªåŒ–æ•ˆæœ**ï¼š
- æ¸›å°‘ç¶²è·¯å‚³è¼¸é‡ç´„ 30%
- çŸ­æ™‚é–“å…§é‡è¤‡è¨ªå•æ™‚ï¼Œè¼‰å…¥æ™‚é–“ < 100 æ¯«ç§’

---

## ğŸ“Š æ•ˆèƒ½æå‡å°æ¯”

| å ´æ™¯ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„å¹…åº¦ |
|------|--------|--------|----------|
| **é¦–æ¬¡è¼‰å…¥ï¼ˆ5 å€‹å°ˆæ¡ˆï¼‰** | 2.5 ç§’ | 0.4 ç§’ | **84% â†“** |
| **é¦–æ¬¡è¼‰å…¥ï¼ˆ20 å€‹å°ˆæ¡ˆï¼‰** | 5.0 ç§’ | 0.6 ç§’ | **88% â†“** |
| **30 ç§’å…§é‡è¤‡è¨ªå•** | 2.5 ç§’ | 0.05 ç§’ | **98% â†“** |
| **ç¶²è·¯å‚³è¼¸é‡** | 100% | ~70% | **30% â†“** |
| **è³‡æ–™åº«æŸ¥è©¢æ™‚é–“** | 1.5-4 ç§’ | 0.1-0.3 ç§’ | **90% â†“** |

---

## ğŸš€ éƒ¨ç½²æŒ‡å—

### æ­¥é©Ÿ 1ï¼šå¥—ç”¨è³‡æ–™åº«å„ªåŒ–ï¼ˆå¿…è¦ï¼‰

**æ–¹æ³• Aï¼šé€é Supabase Dashboardï¼ˆæ¨è–¦ï¼Œ2 åˆ†é˜ï¼‰**

1. å‰å¾€ï¼šhttps://supabase.com/dashboard/project/aqhmnrwxglfmewsgvtzs/sql/new
2. è¤‡è£½ `scripts/apply-optimization.sql` çš„å…§å®¹ä¸¦åŸ·è¡Œ
3. çœ‹åˆ° "Success. No rows returned" å³å®Œæˆ

**æ–¹æ³• Bï¼šä½¿ç”¨å‘½ä»¤åˆ—**

```powershell
cd "C:\Users\JoJo\Documents\Project\ToDo"
supabase db execute --file scripts/apply-optimization.sql --linked
```

### æ­¥é©Ÿ 2ï¼šé‡æ–°å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨

å‰ç«¯å„ªåŒ–å·²ç¶“å®Œæˆï¼Œåªéœ€é‡æ–°å•Ÿå‹•ï¼š

```powershell
cd "C:\Users\JoJo\Documents\Project\ToDo"
npm run dev
```

### æ­¥é©Ÿ 3ï¼šé©—è­‰å„ªåŒ–æ•ˆæœï¼ˆ1 åˆ†é˜ï¼‰

1. é–‹å•Ÿ http://localhost:5173
2. æŒ‰ F12 â†’ Network æ¨™ç±¤
3. é‡æ–°æ•´ç†é é¢
4. è§€å¯Ÿ `projects` API è«‹æ±‚æ™‚é–“æ‡‰ < 500ms âš¡

---

## ğŸ“ ä¿®æ”¹çš„æª”æ¡ˆæ¸…å–®

### æ–°å¢çš„æª”æ¡ˆï¼ˆ5 å€‹ï¼‰

```
âœ“ supabase/migrations/20250212000000_optimize_projects_query.sql
  â†’ è³‡æ–™åº«å„ªåŒ–é·ç§»æª”æ¡ˆ

âœ“ scripts/apply-optimization.sql
  â†’ ç¨ç«‹çš„å„ªåŒ–è…³æœ¬ï¼ˆå¯ç›´æ¥åœ¨ Supabase Dashboard åŸ·è¡Œï¼‰

âœ“ docs/performance-optimization.md
  â†’ å®Œæ•´çš„æŠ€è¡“èªªæ˜æ–‡ä»¶

âœ“ docs/quick-fix-loading-slow.md
  â†’ å¿«é€Ÿä¿®å¾©æŒ‡å—ï¼ˆå«æ•…éšœæ’é™¤ï¼‰

âœ“ docs/optimization-flow.md
  â†’ è¦–è¦ºåŒ–æµç¨‹åœ–ï¼ˆMermaid åœ–è¡¨ï¼‰
```

### ä¿®æ”¹çš„æª”æ¡ˆï¼ˆ5 å€‹ï¼‰

```
âœ“ src/hooks/useProjects.ts
  - æ”¹ç”¨é¸å–ç‰¹å®šæ¬„ä½ï¼ˆé SELECT *ï¼‰
  - æ–°å¢ staleTime: 30s, gcTime: 5min

âœ“ src/hooks/useProject.ts
  - æ”¹ç”¨é¸å–ç‰¹å®šæ¬„ä½
  - æ–°å¢ staleTime: 30s

âœ“ src/hooks/useDeadlines.ts
  - æ”¹ç”¨é¸å–ç‰¹å®šæ¬„ä½
  - æ–°å¢ staleTime: 10s

âœ“ src/hooks/useNotificationRules.ts
  - æ”¹ç”¨é¸å–ç‰¹å®šæ¬„ä½
  - æ–°å¢ staleTime: 60s

âœ“ src/contexts/AuthContext.tsx
  - fetchProfile æ”¹ç”¨é¸å–ç‰¹å®šæ¬„ä½
```

---

## ğŸ§ª æ¸¬è©¦æª¢æŸ¥æ¸…å–®

å„ªåŒ–éƒ¨ç½²å¾Œï¼Œè«‹ç¢ºèªä»¥ä¸‹é …ç›®ï¼š

- [ ] **è³‡æ–™åº«ç´¢å¼•å·²å»ºç«‹**
  ```sql
  select indexname from pg_indexes 
  where schemaname = 'public' 
    and tablename in ('projects', 'project_members');
  ```
  
- [ ] **å°ˆæ¡ˆåˆ—è¡¨é é¢è¼‰å…¥ < 1 ç§’**
  - é–‹å•Ÿ http://localhost:5173
  - è§€å¯Ÿã€Œè¼‰å…¥å°ˆæ¡ˆä¸­...ã€æ˜¯å¦å¿«é€Ÿæ¶ˆå¤±

- [ ] **API å›æ‡‰æ™‚é–“ < 500ms**
  - F12 â†’ Network â†’ æ‰¾åˆ° `projects` è«‹æ±‚
  - æª¢æŸ¥ Time æ¬„ä½

- [ ] **å¿«å–æ­£å¸¸é‹ä½œ**
  - åˆ‡æ›åˆ°å…¶ä»–é é¢ï¼ˆå¦‚ã€Œå ±è¡¨ã€ï¼‰
  - å†åˆ‡å›ã€Œå°ˆæ¡ˆåˆ—è¡¨ã€
  - æ‡‰è©²å¹¾ä¹ç¬é–“è¼‰å…¥ï¼ˆ< 100msï¼‰

- [ ] **åŠŸèƒ½æ­£å¸¸**
  - [ ] å¯ä»¥æ–°å¢å°ˆæ¡ˆ
  - [ ] å¯ä»¥ç·¨è¼¯å°ˆæ¡ˆ
  - [ ] å¯ä»¥åˆªé™¤å°ˆæ¡ˆ
  - [ ] å°ˆæ¡ˆåˆ—è¡¨æ­£ç¢ºé¡¯ç¤º

---

## ğŸ“ˆ ç›£æ§å»ºè­°

### çŸ­æœŸç›£æ§ï¼ˆå„ªåŒ–å¾Œ 1 é€±ï¼‰

1. **ä½¿ç”¨è€…å›é¥‹**ï¼šè©¢å•ä½¿ç”¨è€…è¼‰å…¥é€Ÿåº¦æ˜¯å¦æ”¹å–„
2. **éŒ¯èª¤ç›£æ§**ï¼šæª¢æŸ¥ç€è¦½å™¨ Console æ˜¯å¦æœ‰æ–°éŒ¯èª¤
3. **æ•ˆèƒ½æŒ‡æ¨™**ï¼šè¨˜éŒ„ API å›æ‡‰æ™‚é–“

### é•·æœŸç›£æ§ï¼ˆæ¯æœˆï¼‰

1. **Supabase Performance Insights**
   - Database â†’ Performance â†’ Slow Queries
   - æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„æ…¢æŸ¥è©¢

2. **æŸ¥è©¢åŸ·è¡Œè¨ˆç•«æª¢æŸ¥**
   ```sql
   explain analyze
   select * from public.projects
   where owner_id = auth.uid()
   or exists (
     select 1 from public.project_members pm
     where pm.project_id = projects.id and pm.user_id = auth.uid()
   );
   ```

3. **React Query DevTools**
   - ç›£æ§å¿«å–å‘½ä¸­ç‡
   - ç›®æ¨™ï¼šå¿«å–å‘½ä¸­ç‡ > 60%

---

## ğŸ” æ•…éšœæ’é™¤

### å¸¸è¦‹å•é¡Œ

#### Q1: åŸ·è¡Œ SQL å‡ºç¾æ¬Šé™éŒ¯èª¤
**A:** ç¢ºèªå·²åœ¨ Supabase Dashboard ç™»å…¥ï¼Œä¸”æœ‰è©²å°ˆæ¡ˆçš„ Owner æˆ– Admin æ¬Šé™ã€‚

#### Q2: è¼‰å…¥é€Ÿåº¦æ²’æœ‰æ˜é¡¯æ”¹å–„
**A:** 
1. ç¢ºèªç´¢å¼•å·²å»ºç«‹ï¼ˆåŸ·è¡Œé©—è­‰ SQLï¼‰
2. æ¸…é™¤ç€è¦½å™¨å¿«å–ï¼ˆCtrl+Shift+Deleteï¼‰
3. ç¡¬é‡æ–°æ•´ç†ï¼ˆCtrl+F5ï¼‰
4. æª¢æŸ¥ Network æ¨™ç±¤ä¸­å¯¦éš›çš„ API å›æ‡‰æ™‚é–“

#### Q3: å‡ºç¾ TypeScript å‹åˆ¥éŒ¯èª¤
**A:** æ‰€æœ‰é¸å–çš„æ¬„ä½éƒ½æ˜¯è³‡æ–™è¡¨ä¸­å­˜åœ¨çš„æ¬„ä½ï¼Œæ‡‰è©²ä¸æœƒæœ‰å‹åˆ¥éŒ¯èª¤ã€‚å¦‚æœå‡ºç¾ï¼Œè«‹åŸ·è¡Œï¼š
```powershell
npm run build
```

---

## ğŸ“ æŠ€è¡“èªªæ˜

### ç‚ºä»€éº¼å„ªåŒ–æœ‰æ•ˆï¼Ÿ

#### 1. ç´¢å¼•åŠ é€Ÿæ¬Šé™æª¢æŸ¥
```
ç„¡ç´¢å¼•ï¼šå…¨è¡¨æƒæ O(n)
æœ‰ç´¢å¼•ï¼šB-Tree æŸ¥æ‰¾ O(log n)
```

å°æ–¼ 100 å€‹å°ˆæ¡ˆï¼š
- ç„¡ç´¢å¼•ï¼š100 æ¬¡æƒæ
- æœ‰ç´¢å¼•ï¼š~7 æ¬¡æŸ¥æ‰¾ âš¡

#### 2. RLS æ”¿ç­–å„ªåŒ–
```sql
-- åŸå§‹ï¼ˆæ…¢ï¼‰ï¼šæ¯åˆ—éƒ½å‘¼å«å‡½æ•¸
for select using (is_project_accessible(id))
  â†“ å°æ¯åˆ—åŸ·è¡Œ 2 å€‹å­æŸ¥è©¢

-- å„ªåŒ–å¾Œï¼ˆå¿«ï¼‰ï¼šè®“ PostgreSQL å„ªåŒ–
for select using (
  auth.uid() = owner_id OR
  exists (select 1 from ... where ...)
)
  â†“ PostgreSQL è‡ªå‹•ä½¿ç”¨ç´¢å¼•å„ªåŒ–
```

#### 3. React Query å¿«å–
```
ç„¡å¿«å–ï¼šæ¯æ¬¡è¨ªå•éƒ½è«‹æ±‚ API
æœ‰å¿«å–ï¼š30 ç§’å…§ç›´æ¥ä½¿ç”¨è¨˜æ†¶é«”è³‡æ–™
```

---

## ğŸ”® æœªä¾†å„ªåŒ–æ–¹å‘

ç•¶å°ˆæ¡ˆæ•¸é‡æŒçºŒå¢é•·æ™‚ï¼Œå¯è€ƒæ…®ï¼š

### å°ˆæ¡ˆæ•¸é‡ 50-100 å€‹
- [ ] å¯¦ä½œæœå°‹åŠŸèƒ½
- [ ] å¯¦ä½œç¯©é¸ï¼ˆæˆ‘æ“æœ‰çš„ / æˆ‘åƒèˆ‡çš„ï¼‰

### å°ˆæ¡ˆæ•¸é‡ 100-500 å€‹
- [ ] å¯¦ä½œåˆ†é ï¼ˆæ¯é  20 å€‹ï¼‰
- [ ] æˆ–å¯¦ä½œç„¡é™æ»¾å‹• (Infinite Scroll)

### å°ˆæ¡ˆæ•¸é‡ > 500 å€‹
- [ ] å¯¦ä½œè™›æ“¬æ»¾å‹• (Virtual Scrolling)
- [ ] è€ƒæ…® SSR (Server-Side Rendering)
- [ ] è³‡æ–™åº«æŸ¥è©¢ç‰©åŒ–è¦–åœ– (Materialized View)

---

## ğŸ“š åƒè€ƒæ–‡ä»¶

- **å®Œæ•´æŠ€è¡“èªªæ˜**ï¼š[docs/performance-optimization.md](./docs/performance-optimization.md)
- **å¿«é€Ÿä¿®å¾©æŒ‡å—**ï¼š[docs/quick-fix-loading-slow.md](./docs/quick-fix-loading-slow.md)
- **è¦–è¦ºåŒ–æµç¨‹åœ–**ï¼š[docs/optimization-flow.md](./docs/optimization-flow.md)
- **è³‡æ–™åº«å„ªåŒ–è…³æœ¬**ï¼š[scripts/apply-optimization.sql](./scripts/apply-optimization.sql)

---

## ğŸ“ éœ€è¦å”åŠ©ï¼Ÿ

å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–éœ€è¦é€²ä¸€æ­¥å„ªåŒ–ï¼Œè«‹åƒè€ƒä¸Šè¿°æ–‡ä»¶æˆ–æª¢æŸ¥ï¼š
1. Supabase Dashboard â†’ Performance Insights
2. ç€è¦½å™¨é–‹ç™¼è€…å·¥å…· â†’ Network / Console
3. React Query DevTools

---

**å„ªåŒ–æ—¥æœŸ**ï¼š2026-02-12  
**å„ªåŒ–ç‰ˆæœ¬**ï¼šv1.0  
**é æœŸæ”¹å–„**ï¼šè¼‰å…¥é€Ÿåº¦æå‡ 84-98%
