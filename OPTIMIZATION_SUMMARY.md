# å°ˆæ¡ˆåˆ—è¡¨è¼‰å…¥å„ªåŒ–ç¸½çµ

## ğŸ“‹ å•é¡Œè¨ºæ–·å ±å‘Š

### ç™¼ç¾çš„å•é¡Œ
æ ¹æ“šæˆªåœ–é¡¯ç¤ºï¼Œå°ˆæ¡ˆåˆ—è¡¨é é¢å‡ºç¾ã€Œè¼‰å…¥å°ˆæ¡ˆä¸­...ã€æç¤ºæ™‚é–“éé•·ã€‚

### æ ¹æœ¬åŸå› åˆ†æ

#### ğŸ”´ åš´é‡å•é¡Œ
1. **RLS æ”¿ç­–æ•ˆèƒ½ç“¶é ¸**
   - `is_project_accessible()` å‡½æ•¸å°æ¯åˆ—åŸ·è¡Œ 2 å€‹å­æŸ¥è©¢
   - é€ æˆ N+1 æŸ¥è©¢å•é¡Œ
   - å½±éŸ¿ï¼šæ¯å¤š 1 å€‹å°ˆæ¡ˆï¼ŒæŸ¥è©¢æ™‚é–“å¢åŠ  100-200ms

2. **ç¼ºå°‘è³‡æ–™åº«ç´¢å¼•**
   - `projects.owner_id` - ç„¡ç´¢å¼•
   - `project_members.user_id` - ç„¡ç´¢å¼•
   - `project_members.project_id` - ç„¡ç´¢å¼•
   - å½±éŸ¿ï¼šæ¯æ¬¡æ¬Šé™æª¢æŸ¥éƒ½éœ€è¦å…¨è¡¨æƒæ

#### ğŸŸ¡ æ¬¡è¦å•é¡Œ
3. **å‰ç«¯æŸ¥è©¢æœªå„ªåŒ–**
   - ä½¿ç”¨ `SELECT *` é¸å–æ‰€æœ‰æ¬„ä½
   - æ²’æœ‰å•Ÿç”¨ React Query å¿«å–
   - å½±éŸ¿ï¼šæ¯æ¬¡é€²å…¥é é¢éƒ½é‡æ–°è«‹æ±‚å®Œæ•´è³‡æ–™

---

## âœ… å·²å®Œæˆçš„å„ªåŒ–

### 1. è³‡æ–™åº«å±¤é¢

#### æ–°å¢çš„ç´¢å¼•
```sql
âœ“ idx_projects_owner_id          -- åŠ é€Ÿæ“æœ‰è€…æª¢æŸ¥
âœ“ idx_project_members_user_id    -- åŠ é€Ÿæˆå“¡æ¬Šé™æª¢æŸ¥  
âœ“ idx_project_members_project_id -- åŠ é€Ÿå°ˆæ¡ˆæˆå“¡æŸ¥è©¢
âœ“ idx_projects_updated_at_desc   -- åŠ é€Ÿæ’åº
```

#### é‡å¯«çš„ RLS æ”¿ç­–
```sql
-- åŸå§‹ï¼ˆæ…¢ï¼‰
for select using (public.is_project_accessible(id))

-- å„ªåŒ–å¾Œï¼ˆå¿«ï¼‰
for select using (
  auth.uid() = owner_id
  or
  exists (
    select 1 from public.project_members pm
    where pm.project_id = projects.id 
      and pm.user_id = auth.uid()
  )
)
```

**å„ªåŒ–åŸç†**ï¼šç›´æ¥ä½¿ç”¨ OR æ¢ä»¶ï¼Œè®“ PostgreSQL çš„æŸ¥è©¢å„ªåŒ–å™¨è‡ªå‹•é¸æ“‡æœ€ä½³åŸ·è¡Œè¨ˆç•«ï¼Œä¸¦åˆ©ç”¨ç´¢å¼•åŠ é€Ÿã€‚

### 2. å‰ç«¯å±¤é¢

#### useProjects Hook å„ªåŒ–

**è®Šæ›´å‰ï¼š**
```typescript
.select('*')
// ç„¡å¿«å–é…ç½®
```

**è®Šæ›´å¾Œï¼š**
```typescript
.select('id, name, description, owner_id, created_at, updated_at')
staleTime: 30 * 1000,   // 30 ç§’å…§ä¸é‡æ–°è«‹æ±‚
gcTime: 5 * 60 * 1000,  // å¿«å–ä¿ç•™ 5 åˆ†é˜
```

#### AuthContext å„ªåŒ–

**è®Šæ›´å‰ï¼š**
```typescript
.select('*')
```

**è®Šæ›´å¾Œï¼š**
```typescript
.select('id, display_name, email, line_notify_token, line_user_id, created_at, updated_at')
```

---

## ğŸ“Š é æœŸæ•ˆèƒ½æå‡

| å ´æ™¯ | å„ªåŒ–å‰ | å„ªåŒ–å¾Œ | æ”¹å–„ |
|------|--------|--------|------|
| é¦–æ¬¡è¼‰å…¥ï¼ˆ5 å€‹å°ˆæ¡ˆï¼‰ | 2.5 ç§’ | 400 æ¯«ç§’ | **84%** â†“ |
| é¦–æ¬¡è¼‰å…¥ï¼ˆ20 å€‹å°ˆæ¡ˆï¼‰ | 5.0 ç§’ | 600 æ¯«ç§’ | **88%** â†“ |
| é‡è¤‡è¨ªå•ï¼ˆå¿«å–å‘½ä¸­ï¼‰ | 2.5 ç§’ | 50 æ¯«ç§’ | **98%** â†“ |
| ç¶²è·¯å‚³è¼¸é‡ | 100% | ~70% | **30%** â†“ |

---

## ğŸš€ éƒ¨ç½²æ­¥é©Ÿ

### å¿…è¦æ­¥é©Ÿï¼ˆ5 åˆ†é˜ï¼‰

#### æ­¥é©Ÿ 1ï¼šå¥—ç”¨è³‡æ–™åº«å„ªåŒ–

**é¸é … Aï¼šé€é Supabase Dashboardï¼ˆæ¨è–¦ï¼‰**

1. å‰å¾€ï¼šhttps://supabase.com/dashboard/project/aqhmnrwxglfmewsgvtzs/sql/new
2. è¤‡è£½è²¼ä¸Š `scripts/apply-optimization.sql` çš„å…§å®¹
3. é»æ“Š Run åŸ·è¡Œ

**é¸é … Bï¼šä½¿ç”¨å‘½ä»¤åˆ—**

```powershell
cd "C:\Users\JoJo\Documents\Project\ToDo"
supabase db execute --file scripts/apply-optimization.sql --linked
```

#### æ­¥é©Ÿ 2ï¼šé‡æ–°å•Ÿå‹•é–‹ç™¼ä¼ºæœå™¨

```powershell
# å¦‚æœé–‹ç™¼ä¼ºæœå™¨æ­£åœ¨åŸ·è¡Œï¼Œå…ˆåœæ­¢ï¼ˆCtrl+Cï¼‰
cd "C:\Users\JoJo\Documents\Project\ToDo"
npm run dev
```

#### æ­¥é©Ÿ 3ï¼šé©—è­‰å„ªåŒ–æ•ˆæœ

1. é–‹å•Ÿç€è¦½å™¨ï¼šhttp://localhost:5173
2. æŒ‰ F12 é–‹å•Ÿé–‹ç™¼è€…å·¥å…·
3. åˆ‡æ›åˆ° Network æ¨™ç±¤
4. é‡æ–°æ•´ç†é é¢
5. è§€å¯Ÿ `projects` API è«‹æ±‚æ™‚é–“æ‡‰ < 500ms

---

## ğŸ“ ç›¸é—œæª”æ¡ˆ

### æ–°å¢çš„æª”æ¡ˆ
```
âœ“ supabase/migrations/20250212000000_optimize_projects_query.sql
  - è³‡æ–™åº«å„ªåŒ–é·ç§»æª”æ¡ˆ
  
âœ“ scripts/apply-optimization.sql
  - ç¨ç«‹çš„å„ªåŒ–è…³æœ¬ï¼ˆå¯ç›´æ¥åœ¨ Supabase Dashboard åŸ·è¡Œï¼‰
  
âœ“ docs/performance-optimization.md
  - å®Œæ•´çš„æŠ€è¡“èªªæ˜æ–‡ä»¶
  
âœ“ docs/quick-fix-loading-slow.md
  - å¿«é€Ÿä¿®å¾©æŒ‡å—ï¼ˆå«æ•…éšœæ’é™¤ï¼‰
  
âœ“ OPTIMIZATION_SUMMARY.md (æœ¬æª”æ¡ˆ)
  - å„ªåŒ–ç¸½çµå ±å‘Š
```

### ä¿®æ”¹çš„æª”æ¡ˆ
```
âœ“ src/hooks/useProjects.ts
  - å„ªåŒ–æŸ¥è©¢æ¬„ä½
  - æ–°å¢å¿«å–é…ç½®
  
âœ“ src/contexts/AuthContext.tsx
  - å„ªåŒ– profile æŸ¥è©¢æ¬„ä½
```

---

## ğŸ§ª æ¸¬è©¦æª¢æŸ¥æ¸…å–®

å„ªåŒ–å¾Œè«‹ç¢ºèªä»¥ä¸‹é …ç›®ï¼š

- [ ] å°ˆæ¡ˆåˆ—è¡¨é é¢è¼‰å…¥ < 1 ç§’
- [ ] Network æ¨™ç±¤ä¸­ projects API å›æ‡‰æ™‚é–“ < 500ms
- [ ] åˆ‡æ›åˆ°å…¶ä»–é é¢å†å›ä¾†ï¼Œè¼‰å…¥è¿‘ä¹ç¬é–“ï¼ˆå¿«å–ç”Ÿæ•ˆï¼‰
- [ ] æ–°å¢å°ˆæ¡ˆå¾Œï¼Œåˆ—è¡¨è‡ªå‹•æ›´æ–°
- [ ] åˆªé™¤å°ˆæ¡ˆå¾Œï¼Œåˆ—è¡¨è‡ªå‹•æ›´æ–°
- [ ] å¤šæ¬¡é‡æ–°æ•´ç†é é¢ï¼Œè¼‰å…¥é€Ÿåº¦ç©©å®š

---

## ğŸ” ç›£æ§å»ºè­°

### çŸ­æœŸç›£æ§ï¼ˆå„ªåŒ–å¾Œ 1 é€±ï¼‰
1. **ä½¿ç”¨è€…å›é¥‹**ï¼šè©¢å•ä½¿ç”¨è€…è¼‰å…¥é€Ÿåº¦æ˜¯å¦æ”¹å–„
2. **éŒ¯èª¤ç›£æ§**ï¼šæª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„éŒ¯èª¤å‡ºç¾
3. **æ•ˆèƒ½æŒ‡æ¨™**ï¼šè¨˜éŒ„å¯¦éš›çš„ API å›æ‡‰æ™‚é–“

### é•·æœŸç›£æ§ï¼ˆæ¯æœˆï¼‰
1. **Supabase Performance Insights**ï¼š
   - Database â†’ Performance â†’ Slow Queries
   - æª¢æŸ¥æ˜¯å¦æœ‰æ–°çš„æ…¢æŸ¥è©¢

2. **æŸ¥è©¢åŸ·è¡Œè¨ˆç•«æª¢æŸ¥**ï¼š
   ```sql
   explain analyze
   select * from public.projects
   where owner_id = auth.uid()
   or exists (
     select 1 from public.project_members pm
     where pm.project_id = projects.id 
       and pm.user_id = auth.uid()
   );
   ```

---

## ğŸ› ï¸ æ•…éšœæ’é™¤

è©³ç´°çš„æ•…éšœæ’é™¤æ­¥é©Ÿè«‹åƒè€ƒï¼š[quick-fix-loading-slow.md](./docs/quick-fix-loading-slow.md)

---

## ğŸ“ˆ æœªä¾†å„ªåŒ–æ–¹å‘

ç•¶å°ˆæ¡ˆæ•¸é‡æŒçºŒæˆé•·æ™‚ï¼Œå¯è€ƒæ…®ï¼š

1. **å¯¦ä½œåˆ†é **ï¼ˆå°ˆæ¡ˆ > 50 å€‹æ™‚ï¼‰
   - Infinite scroll æˆ–å‚³çµ±åˆ†é 
   - æ¯é é¡¯ç¤º 20 å€‹å°ˆæ¡ˆ

2. **å¯¦ä½œè™›æ“¬æ»¾å‹•**ï¼ˆå°ˆæ¡ˆ > 100 å€‹æ™‚ï¼‰
   - ä½¿ç”¨ react-window æˆ– react-virtual

3. **å¯¦ä½œæœå°‹èˆ‡ç¯©é¸**
   - å°ˆæ¡ˆåç¨±æœå°‹
   - æŒ‰å»ºç«‹æ™‚é–“/æ›´æ–°æ™‚é–“ç¯©é¸
   - æˆ‘æ“æœ‰çš„ vs æˆ‘åƒèˆ‡çš„

4. **è€ƒæ…®å¿«å–ç­–ç•¥å‡ç´š**
   - Service Worker é›¢ç·šå¿«å–
   - IndexedDB æŒä¹…åŒ–

---

## ğŸ“ æ”¯æ´

å¦‚æœ‰ä»»ä½•å•é¡Œæˆ–å»ºè­°ï¼Œè«‹åƒè€ƒï¼š
- **æŠ€è¡“èªªæ˜**ï¼š`docs/performance-optimization.md`
- **å¿«é€Ÿä¿®å¾©**ï¼š`docs/quick-fix-loading-slow.md`
- **è³‡æ–™åº«è…³æœ¬**ï¼š`scripts/apply-optimization.sql`

---

**å»ºç«‹æ—¥æœŸ**ï¼š2026-02-12  
**å„ªåŒ–ç‰ˆæœ¬**ï¼šv1.0
